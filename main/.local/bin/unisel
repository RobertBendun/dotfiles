#!/bin/sh

# Universal selection of files

prompt() {
	dmenu -i -l 30 -fn "UbuntuMono:size=15" "$@"
}

run() {
	xargs -r -d'\n' -I{} "$@"
}

main() {
	tmp_file="$(mktemp unisel-XXXX)"
	dir="$1"
	prog="$2"
	shift 2

	find -L "$dir" -type f \( "$@" \) > "$tmp_file"
	run -a "$tmp_file" basename "{}" | prompt | run grep -F "{}" "$tmp_file" | head -n1 | run "$prog" "{}"
	rm "$tmp_file"
}

case "$(printf "Edit configs or scripts (WIP)\nWatch videos" | prompt -p "What do you want to do?")" in
	Edit*)
		# TODO fix this
		if [ ! -d "$XDG_CACHE_HOME/unisel" ]; then
			mkdir -p "$XDG_CACHE_HOME/unisel"
			ln -s "XDG_CONFIG_HOME" "$XDG_CACHE_HOME/unisel/"
			ln -s "~/.local/bin" "$XDG_CACHE_HOME/unisel/"
		fi

		main ~/.config/ $EDITOR \
			-type f -depth 3
		;;

	Watch*)
		main ~/downloads mpv \
			-iname "*.mkv" -o -iname "*.mp4" -o -iname "*.avi"
		;;
esac
